---
/**
 * GNB (Global Navigation Bar) 컴포넌트
 * 연수구립도서관 메인 네비게이션 메뉴
 * 새로운 메뉴 구조 데이터를 import하여 사용
 * 완전한 ul > li > a > ol 구조로 통일
 */
import { menuConfig, isExternalLink } from '../../../src/data/menuData';

// 현재 페이지 URL 가져오기 (Astro.url 사용)
const currentPath = Astro.url.pathname;

// GNB에서 표시할 메뉴 항목들 정의 (모든 메뉴를 표시)
const gnbMenuItems = ['도서검색', '책 읽는 연수구', '안내마당', '도서서비스', '열린참여마당', '문화마당', '도서관소개', '나의도서관'];

// 메뉴 데이터를 GNB 형태로 변환하는 함수
function convertToGnbFormat(menuKey) {
	const menu = menuConfig[menuKey];
	if (!menu) return null;

	return {
		title: menu.title,
		// 3depth가 있는 메뉴인지 확인 (하위 아이템에 items가 있는 경우)
		type: menu.sections.some(section => section.items && section.items.length > 0) ? '3depth' : '2depth',
		items: menu.sections.map(section => {
			// 현재 페이지가 이 섹션에 속하는지 확인
			const isSelected = section.href
				? currentPath.includes(section.href)
				: section.items
				? section.items.some(item => currentPath.includes(item.href))
				: false;

			return {
				label: section.title,
				href: section.href || (section.items && section.items.length > 0 ? section.items[0].href : '#'),
				isSelected,
				isExternal: isExternalLink(section.href || '', section.isExternal), // 외부 링크 여부 추가
				subItems: section.items
					? section.items.map(item => ({
							label: item.label,
							href: item.href,
							isSelected: currentPath.includes(item.href),
							isExternal: isExternalLink(item.href, item.isExternal), // 3depth에서도 외부 링크 지원
					  }))
					: undefined,
			};
		}),
	};
}

// GNB용 메뉴 데이터 생성
const menuData = gnbMenuItems.map(menuKey => convertToGnbFormat(menuKey)).filter(Boolean);
---

<nav class="gnb" id="gnb" role="navigation" aria-label="주 메뉴">
	<div class="gnb-main">
		<div class="gnb-container">
			<ul class="gnb-main-list" role="menubar">
				{
					menuData.map(
						(menu, index) =>
							menu && (
								<li class="gnb-main-item" role="none">
									<a
										href={menu.items?.[0]?.href || '#'}
										class={`gnb-main-link ${menu.type !== '1depth' ? 'has-dropdown' : ''}`}
										role="menuitem"
										data-menu-index={index}
									>
										<span class="gnb-main-text">{menu.title}</span>
										{menu.type !== '1depth' && <img src="./assets/images/icon/icon-arrow-down.svg" class="icon icon-arrow-down" />}
									</a>

									{/* 서브메뉴 - 완전한 ul > li > a > ol 구조 */}
									{menu.type !== '1depth' && menu.items && (
										<div class="gnb-sub" hidden>
											<div class="gnb-container">
												<div class="gnb-sub-content">
													<div class="gnb-sub-title">
														<h2 class="gnb-sub-title-text">{menu.title}</h2>
													</div>

													<div class="gnb-sub-menu">
														<ul class="gnb-sub-list">
															{menu.items.map((item, itemIndex) => (
																<li class={`gnb-sub-item ${item.isSelected ? 'selected' : ''}`}>
																	<a
																		href={item.href}
																		class="gnb-sub-link"
																		role="menuitem"
																		{...(item.isExternal && { target: '_blank', rel: 'noopener noreferrer' })}
																	>
																		<span class="gnb-sub-text">{item.label}</span>
																		{/* 외부 링크 아이콘 또는 화살표 아이콘 표시 */}
																		{item.isExternal ? (
																			<img src="./assets/images/icon/icon-external-link.svg" class="icon icon-external-link" alt="외부 링크" />
																		) : item.subItems ? (
																			<img src="./assets/images/icon/icon-arrow-right.svg" class="icon icon-arrow-right" />
																		) : null}
																	</a>

																	{/* 3depth 메뉴 구조 - 완전한 ol 구조 */}
																	{item.subItems && item.subItems.length > 0 && (
																		<ol class="gnb-third-list">
																			<div class="title">
																				<h3 class="gnb-third-title-text">{item.label}</h3>
																			</div>
																			{item.subItems.map(subItem => (
																				<li class={`gnb-third-item ${subItem.isSelected ? 'selected' : ''}`}>
																					<a
																						href={subItem.href}
																						class="gnb-third-link"
																						role="menuitem"
																						{...(subItem.isExternal && { target: '_blank', rel: 'noopener noreferrer' })}
																					>
																						<span class="gnb-third-text">{subItem.label}</span>
																						{/* 3depth에서도 외부 링크 아이콘 표시 */}
																						{subItem.isExternal && (
																							<img
																								src="./assets/images/icon/icon-external-link.svg"
																								class="icon icon-external-link"
																								alt="외부 링크"
																							/>
																						)}
																					</a>
																				</li>
																			))}
																		</ol>
																	)}
																</li>
															))}
														</ul>
													</div>
												</div>
											</div>
										</div>
									)}
								</li>
							)
					)
				}
			</ul>
		</div>
	</div>
</nav>
