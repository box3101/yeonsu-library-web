---
const menuData = [
  {
    title: '도서검색',
    type: '3depth',
    items: [
      { label: '소장도서검색', href: '/01_소장도서검색', isSelected: false },
      { label: '통합검색', href: '/05_통합검색', isSelected: false },
      {
        label: '인기/신착/추천도서',
        href: '/search/popular',
        isSelected: true,
        subItems: [
          { label: '인기도서', href: '/06_인기도서', isSelected: true },
          { label: '신착도서', href: '/search/popular/new', isSelected: false },
          { label: '추천도서', href: '/search/popular/recommended', isSelected: false },
        ],
      },
      { label: '인생서가', href: '/search/life-books', isSelected: false },
      { label: '스쿨북스', href: '/search/school-books', isSelected: false },
      {
        label: '도서탐색',
        href: '/search/explore',
        isSelected: false,
        subItems: [
          { label: '카테고리분류', href: '/search/explore/category', isSelected: false },
          { label: '한국십진분류', href: '/search/explore/decimal', isSelected: false },
        ],
      },
      { label: '스마트도서관비치도서', href: '/02_스마트도서관비치도서', isSelected: false },
    ],
  },
  {
    title: '책 읽는 연수구',
    type: '2depth',
    items: [
      { label: '북스타트', href: '/reading-yeonsu/bookstart', isSelected: true },
      { label: '북메이트', href: '/reading-yeonsu/bookmate', isSelected: false },
      { label: '독서동아리 지원 사업', href: '/reading-yeonsu/reading-clubs', isSelected: false },
      { label: '범구민 책읽어주기 문화운동', href: '/reading-yeonsu/reading-campaign', isSelected: false },
      { label: '북크로싱 센터', href: '/reading-yeonsu/bookcrossing', isSelected: false },
      { label: '영유아 전집 대여 사업', href: '/reading-yeonsu/children-books', isSelected: false },
    ],
  },
  {
    title: '안내마당',
    type: '2depth',
    items: [
      { label: '공지사항', href: '/04_공지사항', isSelected: true },
      { label: '신간희망자료', href: '/info/new-request', isSelected: false },
      { label: '도서관 유튜브', href: '/info/youtube', isSelected: false },
      { label: '도서관 소식지', href: '/info/newsletter', isSelected: false },
      { label: '연수구 지역서점', href: '/info/local-bookstores', isSelected: false },
      { label: '부대시설', href: '/info/facilities', isSelected: false },
      { label: '자주하는 질문', href: '/info/faq', isSelected: false },
    ],
  },
  {
    title: '도서서비스',
    type: '3depth',
    items: [
      { label: '통합도서서비스', href: '/service/integrated', isSelected: true },
      { label: '상호대차서비스', href: '/service/interlibrary', isSelected: false },
      { label: '책바다서비스', href: '/service/bookbada', isSelected: false },
      { label: '책나래서비스', href: '/service/booknare', isSelected: false },
      { label: '모바일도서관', href: '/service/mobile', isSelected: false },
      { label: '스마트도서관', href: '/service/smart', isSelected: false },
      { label: '전자도서관', href: '/service/ebooks', isSelected: false },
      {
        label: '희망도서 신청',
        href: '/service/book-request',
        isSelected: false,
        subItems: [
          { label: '서비스 안내', href: '/service/book-request/info', isSelected: false },
          { label: '서비스 신청', href: '/service/book-request/apply', isSelected: false },
        ],
      },
      {
        label: '희망전자책 신청',
        href: '/service/ebook-request',
        isSelected: false,
        subItems: [
          { label: '서비스 안내', href: '/service/ebook-request/info', isSelected: false },
          { label: '서비스 신청', href: '/service/ebook-request/apply', isSelected: false },
        ],
      },
      {
        label: '무료택배도서대출',
        href: '/service/delivery',
        isSelected: false,
        subItems: [
          { label: '서비스 안내', href: '/service/delivery/info', isSelected: false },
          { label: '서비스 신청', href: '/service/delivery/apply', isSelected: false },
        ],
      },
    ],
  },
  {
    title: '열린참여마당',
    type: '3depth',
    items: [
      { label: '도서관에 바란다', href: '/03_도서관에바란다', isSelected: true },
      { label: '자원봉사', href: '/participation/volunteer', isSelected: false },
      {
        label: '도서관 견학',
        href: '/participation/tour',
        isSelected: false,
        subItems: [
          { label: '도서관 견학 안내', href: '/participation/tour/info', isSelected: false },
          { label: '도서관 견학 신청', href: '/participation/tour/apply', isSelected: false },
        ],
      },
      {
        label: '도서기증',
        href: '/participation/donation',
        isSelected: false,
        subItems: [
          { label: '기증안내', href: '/participation/donation/info', isSelected: false },
          { label: '서약서작성', href: '/participation/donation/pledge', isSelected: false },
          { label: '기증신청조회', href: '/participation/donation/status', isSelected: false },
        ],
      },
      {
        label: '독서마라톤',
        href: '/participation/reading-marathon',
        isSelected: false,
        subItems: [
          { label: '독서마라톤 안내', href: '/participation/reading-marathon/info', isSelected: false },
          { label: '독서마라톤 참여', href: '/participation/reading-marathon/join', isSelected: false },
        ],
      },
      {
        label: '독서왕',
        href: '/participation/reading-king',
        isSelected: false,
        subItems: [
          { label: '독서왕 안내', href: '/participation/reading-king/info', isSelected: false },
          { label: '독서왕 참여', href: '/participation/reading-king/join', isSelected: false },
        ],
      },
      {
        label: '출석체크 이벤트',
        href: '/participation/attendance',
        isSelected: false,
        subItems: [
          { label: '출석체크 안내', href: '/participation/attendance/info', isSelected: false },
          { label: '출석하기', href: '/participation/attendance/check', isSelected: false },
        ],
      },
    ],
  },
  {
    title: '문화마당',
    type: '3depth',
    items: [
      { label: '문화행사 신청', href: '/culture/events' },
      { label: '프로그램 신청', href: '/culture/programs' },
      {
        label: '영화상영',
        href: '/culture/movies',
        subItems: [
          { label: '이용안내', href: '/culture/movies/info' },
          { label: '상영작', href: '/culture/movies/schedule' },
        ],
      },
      {
        label: '대관신청',
        href: '/culture/rental',
        subItems: [
          { label: '공연장(청학,꿈담,송도,해돋이)', href: '/culture/rental/performance' },
          { label: '세미나실대관(청학)', href: '/culture/rental/seminar' },
          { label: '커뮤니티룸대관(동춘)', href: '/culture/rental/community' },
          { label: '프로그램실(함박)', href: '/culture/rental/program' },
          { label: '독서토론실대관(송도)', href: '/culture/rental/discussion' },
          { label: '하늘빛정원대관(청학)', href: '/culture/rental/garden' },
          { label: '동아리실대관(꿈담)', href: '/culture/rental/club' },
        ],
      },
    ],
  },
  {
    title: '도서관소개',
    type: '3depth',
    items: [
      { label: '인사말', href: '/about/greeting', isSelected: true },
      { label: '연혁', href: '/about/history', isSelected: false },
      { label: '상징', href: '/about/symbol', isSelected: false },
      { label: '조직도', href: '/about/organization', isSelected: false },
      { label: '자료현황', href: '/about/materials', isSelected: false },
      {
        label: '구립도서관',
        href: '/about/libraries',
        isSelected: false,
        subItems: [
          { label: '송도국제도서관', href: '/about/libraries/songdo', isSelected: false },
          { label: '연수청학도서관', href: '/about/libraries/cheonghak', isSelected: false },
          { label: '연수꿈담도서관', href: '/about/libraries/ggumdam', isSelected: false },
          { label: '송도국제어린이도서관', href: '/about/libraries/songdo-children', isSelected: false },
          { label: '해돋이도서관', href: '/about/libraries/haedoji', isSelected: false },
          { label: '선학별빛도서관', href: '/about/libraries/sunhak', isSelected: false },
          { label: '동춘나래도서관', href: '/about/libraries/dongchun', isSelected: false },
          { label: '함박비류도서관', href: '/about/libraries/hambak', isSelected: false },
        ],
      },
      {
        label: '공립작은도서관',
        href: '/about/small-libraries',
        isSelected: false,
        subItems: [
          { label: '옥련1동작은도서관', href: '/about/small-libraries/okryeon1', isSelected: false },
          { label: '옥련2동어린이작은도서관', href: '/about/small-libraries/okryeon2-children', isSelected: false },
          { label: '연수1동작은도서관', href: '/about/small-libraries/yeonsu1', isSelected: false },
          { label: '송도2동작은도서관', href: '/about/small-libraries/songdo2', isSelected: false },
          { label: '송도3동작은도서관', href: '/about/small-libraries/songdo3', isSelected: false },
          { label: '송도5동작은도서관', href: '/about/small-libraries/songdo5', isSelected: false },
          { label: '솔안공원작은도서관', href: '/about/small-libraries/solan-park', isSelected: false },
          { label: '해찬솔공원작은도서관', href: '/about/small-libraries/haechansol-park', isSelected: false },
          { label: '누리공원작은도서관', href: '/about/small-libraries/nuri-park', isSelected: false },
          { label: '문화공원 북크로싱 센터', href: '/about/small-libraries/culture-park-bookcrossing', isSelected: false },
        ],
      },
    ],
  },
  {
    title: '개발가이드',
    type: '1depth',
    items: [
      { label: '개발가이드', href: '/guide', isSelected: true },
    ],
  },
];
---

<nav class="gnb" id="gnb" role="navigation" aria-label="주 메뉴">
  <div class="gnb-main">
    <div class="gnb-container">
      <ul class="gnb-main-list" role="menubar">
        {menuData.map((menu, index) => (
          <li class="gnb-main-item" role="none">
            <a 
              href={menu.items[0]?.href} 
              class={`gnb-main-link ${menu.type !== '1depth' ? 'has-dropdown' : ''}`}
              role="menuitem"
              data-menu-index={index}
            >
              <span class="gnb-main-text">{menu.title}</span>
              {menu.type !== '1depth' && (
                <i class="icon icon-sm icon-arrow-down" aria-hidden="true"></i>
              )}
            </a>
            
            {/* 서브메뉴 */}
            {menu.type !== '1depth' && (
              <div class="gnb-sub" hidden>
                <div class="gnb-container">
                  <div class="gnb-sub-content">
                    <!-- 1depth 제목 -->
                    <div class="gnb-sub-title">
                      <h2 class="gnb-sub-title-text">{menu.title}</h2>
                    </div>

                    <!-- 2depth 메뉴 -->
                    <div class="gnb-sub-menu">
                      {menu.items.map((item, itemIndex) => (
                        <div 
                          class={`gnb-sub-item ${item.isSelected ? 'selected' : ''}`} 
                          data-sub-items={item.subItems ? JSON.stringify(item.subItems) : ''}
                        >
                          <a 
                            href={item.href} 
                            class="gnb-sub-link"
                            role="menuitem"
                          >
                            <span class="gnb-sub-text">{item.label}</span>
                            {item.subItems && (
                              <i class="icon icon-xsm icon-arrow-right" aria-hidden="true"></i>
                            )}
                          </a>
                        </div>
                      ))}
                    </div>

                    <!-- 3depth 메뉴 -->
                    <div class="gnb-third" role="region" aria-label="세부 메뉴">
                      <div class="gnb-third-title">
                        <h3 class="gnb-third-title-text" data-third-title>
                          {(() => {
                            const selectedItem = menu.items.find(item => item.isSelected);
                            const targetItem = selectedItem || menu.items[0];
                            return targetItem?.label || '메뉴';
                          })()}
                        </h3>
                      </div>
                      <div class="gnb-third-items" data-third-items>
                        <div class="gnb-third-column">
                          {(() => {
                            const selectedItem = menu.items.find(item => item.isSelected);
                            const targetItem = selectedItem || menu.items[0];
                            
                            if (targetItem?.subItems && targetItem.subItems.length > 0) {
                              return targetItem.subItems.map((item) => (
                                <div class={`gnb-third-item ${item.isSelected ? 'selected' : ''}`}>
                                  <a href={item.href} class="gnb-third-link">
                                    <span class="gnb-third-text">{item.label}</span>
                                  </a>
                                </div>
                              ));
                            }
                            // 3depth 없으면 아무것도 렌더링 안 함 (타이틀만 남음)
                            return null;
                          })()}
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            )}
          </li>
        ))}
      </ul>
    </div>
  </div>
</nav>

<style lang="scss">
  @use '@styles/abstracts' as *;
  @use '@styles/variables/colors' as *;

  .gnb {
    position: relative;
    z-index: 1000;
    --radius-medium2: #{to-rem(6)};
    --color-primary-pr01: #d8e4f3;

    &-container {
      max-width: 1280px;
      margin: 0 auto;
    }
  }

  // 메인 메뉴 바
  .gnb-main {
    background: #ffffff;
    border-top: 1px solid #cdd1d5;
    border-bottom: 1px solid #cdd1d5;

    &-list {
      @include flex(row, flex-start, stretch);
      list-style: none;
      margin: 0;
      padding: 0;
      gap: to-rem(16);
      height: to-rem(56);
    }

    &-link {
      @include flex(row, space-between, center);
      gap: to-rem(8);
      padding: 0 to-rem(16);
      height: to-rem(56);
      width: to-rem(169);
      background: transparent;
      border: none;
      cursor: pointer;
      font-family: 'Pretendard GOV', sans-serif;
      font-size: to-rem(19);
      font-weight: 700;
      line-height: 1.5;
      color: #464c53;
      transition: all 0.2s ease;
      text-decoration: none;

      &:hover {
        background: #f8fafc;
      }

      &.selected {
        border-bottom: 4px solid #244874;
        background: #ffffff;
      }

      &:focus {
        outline: 2px solid #244874;
        outline-offset: 2px;
      }
    }

    &-text {
      flex: 1;
      text-align: left;
      white-space: nowrap;
    }
  }

  // 서브 메뉴 영역
  .gnb-sub {
    background: #ffffff;
    border-top: 1px solid #cdd1d5;
    border-bottom: 1px solid #cdd1d5;
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    z-index: 999;
    opacity: 0;
    visibility: hidden;
    transform: translateY(-10px);
    transition: all 0.3s ease;

    &[hidden] {
      display: none !important;
    }

    &:not([hidden]) {
      opacity: 1;
      visibility: visible;
      transform: translateY(0);
    }

    &-content {
      @include flex(row, flex-start, stretch);
      padding: to-rem(16) 0;
      gap: to-rem(24);
    }

    &-title {
      width: to-rem(306);
      padding-right: to-rem(24);

      &-text {
        font-family: 'Pretendard GOV', sans-serif;
        font-size: to-rem(24);
        font-weight: 700;
        line-height: 1.5;
        color: #1e2124;
        margin: 0;
        padding: to-rem(16) to-rem(4);
      }
    }

    &-menu {
      width: to-rem(306);
      padding-top: to-rem(8);
      padding-right: to-rem(24);
      @include flex(column, flex-start, stretch);
      gap: to-rem(4);
    }

    &-item {
      border-radius: to-rem(8);
      transition: all 0.2s ease;

      &.selected {
        background: #ecf2f9;
      }

      &:hover {
        background: #f8fafc;
      }
    }

    &-link {
      @include flex(row, space-between, center);
      width: 100%;
      padding: to-rem(16);
      text-decoration: none;
      background: none;
      border: none;
      cursor: pointer;
      border-radius: to-rem(8);
      color: inherit;

      &:focus {
        outline: 2px solid #244874;
        outline-offset: 2px;
        background: #f8fafc;
      }
    }

    &-text {
      flex: 1;
      font-family: 'Pretendard GOV', sans-serif;
      font-size: to-rem(17);
      font-weight: 400;
      line-height: 1.5;
      color: #1e2124;
      text-align: left;

      .selected & {
        font-weight: 700;
        color: #052b57;
      }
    }
  }

  // 3depth 메뉴
  .gnb-third {
    flex: 1;
    align-self: stretch;
    border-left: 1px solid #cdd1d5;
    padding: to-rem(8) to-rem(24);

    &-title {
      margin-bottom: to-rem(16);

      &-text {
        font-family: 'Pretendard GOV', sans-serif;
        font-size: to-rem(20);
        font-weight: 700;
        line-height: 1.5;
        color: #1e2124;
        margin: 0;
        padding: to-rem(8) 0;
      }
    }

    &-items {
      &:empty {
        display: none;
      }
    }

    &-column {
      @include flex(column, flex-start, stretch);
      width: to-rem(298);
    }

    &-item {
      display: flex;
      align-items: center;
      gap: var(--gap-2, 4px);
      align-self: stretch;
      border-radius: var(--radius-medium2, 6px);
      background: var(--color-action-secondary, rgba(255, 255, 255, 0));
      position: relative;
      transition: all 0.2s ease;

      &.selected {
        background: var(--color-primary-pr01);
      }

      @include makeBefore {
        @include ab-y;
        left: 6px;
        width: 4px;
        height: 4px;
        border-radius: 50%;
        background: #000;
      }

      &:hover {
        border-radius: var(--radius-medium2, 6px);
        background: var(--color-primary-pr01, #d8e4f3);

        .gnb-third-text {
          color: $primary-color !important;
          font-weight: 700 !important;
        }
      }
    }

    &-link {
      display: block;
      width: 100%;
      height: 100%;
      padding: var(--padding-4, 18px) var(--padding-3, 8px);
      padding-left: 22px;
      text-decoration: none;
      color: inherit;

      &:focus {
        outline: 2px solid #244874;
        outline-offset: 2px;
      }
    }

    &-text {
      @include font(to-rem(17), 400, #121212);
    }
  }

  @include mobile {
    .gnb {
      display: none;
    }
  }

  @media (prefers-contrast: high) {
    .gnb {
      &-main-link:focus,
      &-sub-link:focus,
      &-third-link:focus {
        outline: 3px solid #000;
        outline-offset: 2px;
      }
    }
  }

  @media (prefers-reduced-motion: reduce) {
    .gnb-sub {
      transition: none;
    }
    
    .gnb-main-link,
    .gnb-sub-item,
    .gnb-third-item {
      transition: none;
    }
  }
</style>

<script>
(function() {
  const gnb = document.getElementById('gnb');
  if (!gnb) return;

  // 간단한 호버/포커스 기반 서브메뉴 표시
  const mainItems = gnb.querySelectorAll('.gnb-main-item');
  
  mainItems.forEach((item, index) => {
    const mainLink = item.querySelector('.gnb-main-link');
    const submenu = item.querySelector('.gnb-sub');
    
    if (!submenu) return;

    // 호버 이벤트
    item.addEventListener('mouseenter', () => showSubmenu(submenu));
    item.addEventListener('mouseleave', (e) => {
      if (!submenu.contains(e.relatedTarget)) {
        setTimeout(() => hideSubmenu(submenu), 100);
      }
    });

    // 포커스 이벤트
    mainLink.addEventListener('focus', () => showSubmenu(submenu));

    // 2depth 호버 시 3depth 업데이트
    const subItems = submenu.querySelectorAll('.gnb-sub-item');
    const thirdTitle = submenu.querySelector('[data-third-title]');
    const thirdItems = submenu.querySelector('[data-third-items]');

    subItems.forEach((subItem) => {
      const subLink = subItem.querySelector('.gnb-sub-link');
      
      ['mouseenter', 'focus'].forEach(eventType => {
        subLink.addEventListener(eventType, () => {
          updateThirdContent(subItem, thirdTitle, thirdItems);
        });
      });
    });
  });

  // 전체 GNB 벗어날 때 숨기기
  gnb.addEventListener('mouseleave', () => {
    gnb.querySelectorAll('.gnb-sub').forEach(hideSubmenu);
  });

  function showSubmenu(submenu) {
    hideAllSubmenus();
    submenu.hidden = false;
  }

  function hideSubmenu(submenu) {
    submenu.hidden = true;
  }

  function hideAllSubmenus() {
    gnb.querySelectorAll('.gnb-sub').forEach(hideSubmenu);
  }

  function updateThirdContent(subItem, thirdTitle, thirdItems) {
    const label = subItem.querySelector('.gnb-sub-text')?.textContent;
    const subItemsData = subItem.getAttribute('data-sub-items');
    
    // 선택된 상태 업데이트
    subItem.parentElement.querySelectorAll('.gnb-sub-item').forEach(item => {
      item.classList.remove('selected');
    });
    subItem.classList.add('selected');
    
    // 타이틀 업데이트
    if (thirdTitle && label) {
      thirdTitle.textContent = label;
    }
    
    // 3depth 컨텐츠 업데이트
    if (thirdItems && subItemsData && subItemsData !== '') {
      try {
        const subItemsParsed = JSON.parse(subItemsData);
        thirdItems.innerHTML = `
          <div class="gnb-third-column">
            ${subItemsParsed.map(item => `
              <div class="gnb-third-item ${item.isSelected ? 'selected' : ''}">
                <a href="${item.href}" class="gnb-third-link">
                  <span class="gnb-third-text">${item.label}</span>
                </a>
              </div>
            `).join('')}
          </div>
        `;
      } catch (e) {
        thirdItems.innerHTML = '';
      }
    } else {
      thirdItems.innerHTML = '';
    }
  }
})();
</script>