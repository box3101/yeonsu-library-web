---
const menuData = [
  {
    title: '도서검색',
    type: '2depth',
    items: [
      { label: '소장도서검색', href: './01_소장도서검색' },
      { label: '스마트도서관비치도서', href: './01-2.스마트도서관비치도서' },
      { label: '신착도서', href: '/new-books' },
      { label: '추천도서', href: '/recommended-books' },
      { label: '베스트셀러', href: '/bestsellers' }
    ]
  },
  {
    title: '책 읽는 연수구',
    type: '3depth',
    items: [
      {
        label: '독서의 달',
        href: '/reading-month',
        subItems: [
          { label: '독서의 달 소개', href: '/reading-month/intro' },
          { label: '참여 이벤트', href: '/reading-month/events' },
          { label: '독서 캠페인', href: '/reading-month/campaign' },
          { label: '우수 참여자', href: '/reading-month/winners' }
        ]
      },
      {
        label: '책 읽는 연수구 만들기',
        href: '/reading-yeonsu',
        isSelected: true,
        subItems: [
          { label: '사업소개', href: '/reading-yeonsu/intro', isSelected: true },
          { label: '참여방법', href: '/reading-yeonsu/participate' },
          { label: '독서후기', href: '/reading-yeonsu/reviews' },
          { label: '우수작 선정', href: '/reading-yeonsu/awards' }
        ]
      },
      {
        label: '시민추천도서',
        href: '/citizen-books',
        subItems: [
          { label: '추천도서 목록', href: '/citizen-books/list' },
          { label: '도서 추천하기', href: '/citizen-books/recommend' },
          { label: '추천 후기', href: '/citizen-books/reviews' }
        ]
      },
      {
        label: '독서동아리',
        href: '/reading-clubs',
        subItems: [
          { label: '동아리 소개', href: '/reading-clubs/intro' },
          { label: '가입신청', href: '/reading-clubs/join' },
          { label: '활동현황', href: '/reading-clubs/activities' }
        ]
      },
      {
        label: '원북원시티',
        href: '/one-book-one-city',
        subItems: [
          { label: '선정도서', href: '/one-book-one-city/book' },
          { label: '참여방법', href: '/one-book-one-city/how-to' },
          { label: '독서토론', href: '/one-book-one-city/discussion' }
        ]
      }
    ]
  },
  {
    title: '안내마당',
    type: '3depth',
    items: [
      {
        label: '도서관소개',
        href: '/info/about',
        subItems: [
          { label: '관장인사말', href: '/info/about/greeting' },
          { label: '운영방침', href: '/info/about/policy' },
          { label: '연혁', href: '/info/about/history' }
        ]
      },
      {
        label: '이용안내',
        href: '/info/guide',
        isSelected: true,
        subItems: [
          { label: '대출/반납안내', href: '/info/guide/loan', isSelected: true },
          { label: '회원가입안내', href: '/info/guide/membership' },
          { label: '이용시간', href: '/info/guide/hours' },
          { label: '휴관일안내', href: '/info/guide/holidays' },
          { label: '이용규칙', href: '/info/guide/rules' }
        ]
      },
      {
        label: '층별안내',
        href: '/info/floor-guide',
        subItems: [
          { label: '1층 안내', href: '/info/floor-guide/1f' },
          { label: '2층 안내', href: '/info/floor-guide/2f' },
          { label: '3층 안내', href: '/info/floor-guide/3f' }
        ]
      },
      {
        label: '찾아오시는 길',
        href: '/info/location',
        subItems: [
          { label: '교통편 안내', href: '/info/location/transport' },
          { label: '주차 안내', href: '/info/location/parking' },
          { label: '지도', href: '/info/location/map' }
        ]
      },
      {
        label: '시설현황',
        href: '/info/facilities',
        subItems: [
          { label: '열람실', href: '/info/facilities/reading-room' },
          { label: '디지털자료실', href: '/info/facilities/digital' },
          { label: '문화공간', href: '/info/facilities/culture' }
        ]
      }
    ]
  },
  {
    title: '도서서비스',
    type: '2depth',
    items: [
      { label: '전자책', href: '/service/ebooks' },
      { label: '오디오북', href: '/service/audiobooks' },
      { label: '디지털컬렉션', href: '/service/digital-collection' },
      { label: '온라인DB', href: '/service/database' }
    ]
  },
  {
    title: '열린참여마당',
    type: '3depth',
    items: [
      { label: '도서관에 바란다', href: '/BBS_USER_REG1_LIST_도서관에바란다' },
      { label: '자원봉사', href: '/volunteer' },
      { label: '도서관 견학', href: '/tour', isSelected: true },
      { label: '도서기증', href: '/donation' },
      { label: '독서마라톤', href: '/reading-marathon' },
      { label: '독서왕', href: '/reading-king' },
      { label: '출석체크 이벤트', href: '/attendance-event' }
    ],
    subCategories: [
      {
        title: '도서관 견학',
        items: [
          { label: '견학신청', href: '/tour/application', isSelected: true },
          { label: '견학안내', href: '/tour/guide' },
          { label: '견학후기', href: '/tour/reviews' },
          { label: '견학일정조회', href: '/tour/schedule' }
        ]
      }
    ]
  },
  {
    title: '문화마당',
    type: '3depth',
    items: [
      { label: '문화행사', href: '/culture/events' },
      { label: '강좌신청', href: '/culture/lectures', isSelected: true },
      { label: '전시안내', href: '/culture/exhibitions' },
      { label: '공연안내', href: '/culture/performances' },
      { label: '작은도서관', href: '/culture/small-library' }
    ],
    subCategories: [
      {
        title: '강좌신청',
        items: [
          { label: '성인강좌', href: '/culture/lectures/adult', isSelected: true },
          { label: '어린이강좌', href: '/culture/lectures/children' },
          { label: '청소년강좌', href: '/culture/lectures/youth' },
          { label: '온라인강좌', href: '/culture/lectures/online' }
        ]
      }
    ]
  },
  {
    title: '도서관소개',
    type: '2depth',
    items: [
      { label: '관장인사말', href: '/about/greeting' },
      { label: '연혁', href: '/about/history' },
      { label: '조직도', href: '/about/organization' },
      { label: '도서관현황', href: '/about/status' },
      { label: '연간운영계획', href: '/about/plan' }
    ]
  }
];
---

<nav class="gnb" id="gnb">
  <!-- 메인 메뉴 바 -->
  <div class="gnb-main">
    <div class="gnb-container">
      <ul class="gnb-main-list">
        {menuData.map((menu, index) => (
          <li class="gnb-main-item" data-menu-index={index}>
            <a href={menu.items[0]?.href} class={`gnb-main-link ${menu.type !== '1depth' ? 'has-dropdown' : ''}`}>
              <span class="gnb-main-text">{menu.title}</span>
              {menu.type !== '1depth' && (
                <i class="icon icon-sm icon-arrow-down"></i>
              )}
            </a>
          </li>
        ))}
      </ul>
    </div>
  </div>

  <!-- 서브 메뉴 -->
  {menuData.map((menu, index) =>
    menu.type !== '1depth' && (
      <div class="gnb-sub" data-menu-target={index}>
        <div class="gnb-container">
          <div class="gnb-sub-content">
            <!-- 1depth 제목 -->
            <div class="gnb-sub-title">
              <h2 class="gnb-sub-title-text">{menu.title}</h2>
            </div>

            <!-- 2depth 메뉴 -->
            <div class="gnb-sub-menu">
              {menu.items.map(item => (
                <div class={`gnb-sub-item ${item.isSelected ? 'selected' : ''}`}>
                  <a href={item.href} class="gnb-sub-link">
                    <span class="gnb-sub-text">{item.label}</span>
                    {menu.type === '3depth' && (
                      <i class="icon icon-xsm icon-arrow-right"></i>
                    )}
                  </a>
                </div>
              ))}
            </div>

            <!-- 3depth 메뉴 -->
            {menu.type === '3depth' && (
              <div class="gnb-third">
                <div class="gnb-third-title">
                  <h3 class="gnb-third-title-text" data-third-title>
                    {menu.items.find(item => item.isSelected)?.label || menu.items[0]?.label || '3depth 메뉴'}
                  </h3>
                </div>
                <div class="gnb-third-items">
                  <div class="gnb-third-column" data-third-items>
                    {(menu.items.find(item => item.isSelected)?.subItems ||
                      menu.items[0]?.subItems || []).map(item => (
                      <div class={`gnb-third-item ${item.isSelected ? 'selected' : ''}`}>
                        <a href={item.href} class="gnb-third-link">
                          <span class="gnb-third-text">{item.label}</span>
                        </a>
                      </div>
                    ))}
                  </div>
                </div>
              </div>
            )}
          </div>
        </div>
      </div>
    )
  )}
</nav>

<style lang="scss">
  @use '@styles/abstracts' as *;
  @use '@styles/variables/colors' as *;

  .gnb {
    position: relative;
    z-index: 1000;
    --radius-medium2: #{to-rem(6)};
    --color-primary-pr01: #d8e4f3;

    &-container {
      max-width: 1280px;
      margin: 0 auto;
    }
  }

  // 메인 메뉴 바
  .gnb-main {
    background: #ffffff;
    border-top: 1px solid #cdd1d5;
    border-bottom: 1px solid #cdd1d5;

    &-list {
      @include flex(row, flex-start, stretch);
      list-style: none;
      margin: 0;
      padding: 0;
      gap: to-rem(16);
      height: to-rem(56);
    }

    &-link {
      @include flex(row, space-between, center);
      gap: to-rem(8);
      padding: 0 to-rem(16);
      height: to-rem(56);
      width: to-rem(169);
      background: transparent;
      border: none;
      cursor: pointer;
      font-family: 'Pretendard GOV', sans-serif;
      font-size: to-rem(19);
      font-weight: 700;
      line-height: 1.5;
      color: #464c53;
      transition: all 0.2s ease;

      &:hover {
        background: #f8fafc;
      }

      &.selected {
        border-bottom: 4px solid #244874;
        background: #ffffff;
      }
    }

    &-text {
      flex: 1;
      text-align: left;
      white-space: nowrap;
    }
  }

  // 서브 메뉴 영역
  .gnb-sub {
    background: #ffffff;
    border-top: 1px solid #cdd1d5;
    border-bottom: 1px solid #cdd1d5;
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    z-index: 999;
    opacity: 0;
    visibility: hidden;
    transform: translateY(-10px);
    transition: all 0.3s ease;

    &-content {
      @include flex(row, flex-start, stretch);
      padding: to-rem(16) 0;
      gap: to-rem(24);
    }

    &-title {
      width: to-rem(306);
      padding-right: to-rem(24);

      &-text {
        font-family: 'Pretendard GOV', sans-serif;
        font-size: to-rem(24);
        font-weight: 700;
        line-height: 1.5;
        color: #1e2124;
        margin: 0;
        padding: to-rem(16) to-rem(4);
      }
    }

    &-menu {
      width: to-rem(306);
      padding-top: to-rem(8);
      padding-right: to-rem(24);
      @include flex(column, flex-start, stretch);
      gap: to-rem(4);
    }

    &-item {
      border-radius: to-rem(8);
      transition: all 0.2s ease;

      &.selected {
        background: #ecf2f9;
      }

      &:hover {
        background: #f8fafc;
      }
    }

    &-link {
      @include flex(row, space-between, center);
      width: 100%;
      padding: to-rem(16);
      text-decoration: none;
      background: none;
      border: none;
      cursor: pointer;
      border-radius: to-rem(8);
    }

    &-text {
      flex: 1;
      font-family: 'Pretendard GOV', sans-serif;
      font-size: to-rem(17);
      font-weight: 400;
      line-height: 1.5;
      color: #1e2124;
      text-align: left;

      .selected & {
        font-weight: 700;
        color: #052b57;
      }
    }
  }

  // 3depth 메뉴
  .gnb-third {
    flex: 1;
    align-self: stretch;
    border-left: 1px solid #cdd1d5;
    padding: to-rem(8) to-rem(24);

    &-title {
      margin-bottom: to-rem(16);

    }

    &-column {
      @include flex(column, flex-start, stretch);
      width: to-rem(298);
    }

    &-item {
      border-radius: var(--radius-medium2);
      transition: all 0.2s ease;

      &.selected {
        background: var(--color-primary-pr01);
      }

      &:hover {
        background: #f1f5f9;
      }
    }

    //  GNB
    .gnb-third-item {
      display: flex;
      align-items: center;
      gap: var(--gap-2, 4px);
      align-self: stretch;
      border-radius: var(--radius-medium2, 6px);
      background: var(--color-action-secondary, rgba(255, 255, 255, 0));
      position: relative;
      @include makeBefore {
        @include ab-y;
        left: 6px;
        width: 4px;
        height: 4px;
        border-radius: 50%;
        background: #000;
      }
      .gnb-third-link {
        display: block;
        width: 100%;
        height: 100%;
        padding: var(--padding-4, 18px) var(--padding-3, 8px);
        padding-left: 22px;
        .gnb-third-text {
          @include font(to-rem(17), 400, #121212);
        }
      }
      &:hover {
        border-radius: var(--radius-medium2, 6px);
        background: var(--color-primary-pr01, #d8e4f3);
        .gnb-third-text {
          color: $primary-color !important;
          font-weight: 700 !important;
        }
      }
    }
  }

  @include mobile {
    .gnb {
      display: none;
    }
  }
</style>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    const gnbItems = document.querySelectorAll('.gnb-main-item[data-menu-index]');
    const gnbSubs = document.querySelectorAll('.gnb-sub[data-menu-target]');
    let currentTimeout = null;

    gnbItems.forEach((item) => {
      const menuIndex = item.getAttribute('data-menu-index');
      const correspondingSub = document.querySelector(`.gnb-sub[data-menu-target="${menuIndex}"]`);

      if (!correspondingSub) return;

      // 메인 메뉴 호버 이벤트
      item.addEventListener('mouseenter', () => {
        if (currentTimeout) {
          clearTimeout(currentTimeout);
          currentTimeout = null;
        }

        gnbSubs.forEach(sub => {
          sub.style.opacity = '0';
          sub.style.visibility = 'hidden';
          sub.style.transform = 'translateY(-10px)';
        });

        correspondingSub.style.opacity = '1';
        correspondingSub.style.visibility = 'visible';
        correspondingSub.style.transform = 'translateY(0)';
      });

      item.addEventListener('mouseleave', (e) => {
        if (!correspondingSub.contains(e.relatedTarget)) {
          currentTimeout = setTimeout(() => {
            correspondingSub.style.opacity = '0';
            correspondingSub.style.visibility = 'hidden';
            correspondingSub.style.transform = 'translateY(-10px)';
          }, 100);
        }
      });

      // 서브 메뉴 호버 이벤트
      correspondingSub.addEventListener('mouseenter', () => {
        if (currentTimeout) {
          clearTimeout(currentTimeout);
          currentTimeout = null;
        }
      });

      correspondingSub.addEventListener('mouseleave', (e) => {
        if (!item.contains(e.relatedTarget)) {
          correspondingSub.style.opacity = '0';
          correspondingSub.style.visibility = 'hidden';
          correspondingSub.style.transform = 'translateY(-10px)';
        }
      });

      // 2depth 메뉴 항목들의 호버 이벤트 (3depth용)
      const subItems = correspondingSub.querySelectorAll('.gnb-sub-item');
      subItems.forEach((subItem, subIndex) => {
        subItem.addEventListener('mouseenter', () => {
          subItems.forEach((item, idx) => {
            item.classList.toggle('selected', idx === subIndex);
          });
        });
      });
    });

    // 전체 GNB 영역을 벗어나면 숨기기
    document.getElementById('gnb').addEventListener('mouseleave', () => {
      gnbSubs.forEach(sub => {
        sub.style.opacity = '0';
        sub.style.visibility = 'hidden';
        sub.style.transform = 'translateY(-10px)';
      });
    });
  });
</script>